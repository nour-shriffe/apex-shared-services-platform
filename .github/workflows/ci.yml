name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint-docs:
    name: lint-docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: |
            **/*.md

  validate-yaml:
    name: validate-yaml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate GitHub Actions workflows
        uses: rhysd/actionlint@v1.7.10

      - name: YAML lint (basic)
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/workflows
          config_data: |
            extends: default
            rules:
              document-start: disable
              line-length: disable
              truthy: disable
              comments-indentation: disable

  db-static-check:
    name: db-static-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Placeholder SQL checks
        shell: bash
        run: |
          set -euo pipefail
          echo "DB static checks (placeholder)"
          if [[ ! -d db ]]; then
            echo "No db/ directory in the checkout (empty dirs are not tracked by git)."
            exit 0
          fi
          count="$(find db -type f \( -name '*.sql' -o -name '*.psql' \) | wc -l | tr -d ' ')"
          echo "Found ${count} SQL file(s)."
          find db -type f \( -name '*.sql' -o -name '*.psql' \) -print || true
          echo "TODO: add SQL linting here."
